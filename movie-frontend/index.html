<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MovieVerse - Interactive Beta</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      :root {
        --bg: #050505;
        --card: #151515;
        --primary: #e50914;
        --text: #fff;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        overflow-x: hidden;
      }

      /* NAVBAR */
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 40px;
        background: rgba(0, 0, 0, 0.85);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(10px);
        box-sizing: border-box;
        border-bottom: 1px solid #333;
      }
      .logo {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        letter-spacing: -1px;
      }
      .logo span {
        color: white;
      }

      /* SEARCH & FILTER BAR */
      .search-container {
        display: flex;
        gap: 10px;
        background: #222;
        padding: 5px 15px;
        border-radius: 50px;
        border: 1px solid #333;
      }
      .search-container input {
        background: transparent;
        border: none;
        color: white;
        outline: none;
        padding: 5px;
        width: 200px;
      }
      .search-container select {
        background: #333;
        border: none;
        color: #aaa;
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
      }

      .nav-icons i {
        margin-left: 20px;
        cursor: pointer;
        transition: 0.2s;
      }
      .nav-icons i:hover {
        color: var(--primary);
      }

      .container {
        padding: 100px 50px;
      }

      /* GRID */
      .movie-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 25px;
        margin-top: 20px;
      }
      .card {
        background: var(--card);
        border-radius: 8px;
        overflow: hidden;
        transition: 0.3s;
        position: relative;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(229, 9, 20, 0.2);
      }
      .card img {
        width: 100%;
        height: 280px;
        object-fit: cover;
      }
      .card-info {
        padding: 15px;
      }
      .card-info h3 {
        margin: 0;
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .card-info p {
        color: #777;
        font-size: 0.8rem;
        margin-top: 5px;
      }

      /* 3D SPHERE SECTION */
      #sphere-section {
        height: 90vh;
        width: 100%;
        position: relative;
        border-top: 1px solid #333;
      }
      #canvas-container {
        width: 100%;
        height: 100%;
      }
      #sphere-ui {
        position: absolute;
        top: 50px;
        left: 50px;
        z-index: 10;
        pointer-events: none;
      }

      /* LOGIN MODAL */
      #login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: #1a1a1a;
        padding: 40px;
        border-radius: 10px;
        width: 300px;
        text-align: center;
        border: 1px solid #333;
      }
      .modal-content input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        background: #333;
        border: none;
        color: white;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .modal-content button {
        width: 100%;
        padding: 10px;
        background: var(--primary);
        border: none;
        color: white;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
      }
      .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="login-modal">
      <div class="modal-content">
        <span
          class="close-btn"
          onclick="document.getElementById('login-modal').style.display='none'"
          >&times;</span
        >
        <h2>Welcome Back</h2>
        <input type="email" placeholder="Email" />
        <input type="password" placeholder="Password" />
        <button onclick="alert('Step 1: Button Clicked'); handleLogin()">
          Sign In
        </button>
      </div>
    </div>
    <div
      id="profile-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
      "
    >
      <div
        class="modal-content"
        style="
          width: 400px;
          text-align: left;
          max-height: 80vh;
          overflow-y: auto;
        "
      >
        <span
          class="close-btn"
          onclick="document.getElementById('profile-modal').style.display='none'"
          style="float: right; cursor: pointer; font-size: 24px"
          >&times;</span
        >
        <h2 style="margin-top: 0">My Search History</h2>

        <ul id="history-list" style="list-style: none; padding: 0; color: #aaa">
          <li>Loading...</li>
        </ul>

        <div
          style="
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 20px;
          "
        >
          <button onclick="logout()" style="background: #333; width: 100%">
            Log Out
          </button>
        </div>
      </div>
    </div>

    <nav>
      <div class="logo">MOVIE<span>VERSE</span></div>

      <div class="search-container">
        <i data-lucide="search" style="width: 16px; color: #777"></i>
        <input
          type="text"
          id="search-input"
          placeholder="Search movies, years..."
        />
        <select id="genre-select">
          <option value="All">All Genres</option>
          <option value="Action">Action</option>
          <option value="Sci-Fi">Sci-Fi</option>
          <option value="Drama">Drama</option>
        </select>
      </div>

      <div class="nav-icons">
        <i
          data-lucide="user"
          onclick="document.getElementById('login-modal').style.display='flex'"
        ></i>
      </div>
    </nav>

    <section class="container">
      <h1 id="grid-title">Trending Now</h1>
      <div class="movie-grid" id="movie-grid"></div>
    </section>

    <section id="sphere-section">
      <div id="sphere-ui">
        <h2>3D Explorer</h2>
        <p style="color: #aaa">
          Visualizing <span id="count-display">20</span> movies
        </p>
      </div>
      <div id="canvas-container"></div>
    </section>

    <script>
      async function handleLogin() {
        // ... (Validation code is the same) ...
        const inputs = document.querySelectorAll(".modal-content input");
        const email = inputs[0].value;
        const password = inputs[1].value;

        const formData = new URLSearchParams();
        formData.append("username", email);
        formData.append("password", password);

        try {
          const response = await fetch("http://127.0.0.1:8000/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData,
          });

          if (response.ok) {
            const data = await response.json();

            // 1. SAVE TOKEN
            localStorage.setItem("token", data.access_token);

            // 2. *** UPDATE UI IMMEDIATELY *** (Add this line)
            checkLoginState();

            alert("Login Successful!");
            document.getElementById("login-modal").style.display = "none";
          } else {
            alert("Login Failed");
          }
        } catch (error) {
          console.error(error);
          alert("Server error");
        }
      }
      function checkLoginState() {
        const token = localStorage.getItem("token");
        const userIcon = document.querySelector(".nav-icons i");

        if (token) {
          // User is logged in: Change icon to Green
          userIcon.style.color = "#46d369";
          userIcon.setAttribute("onclick", "logout()"); // Change click action
        } else {
          // User is logged out: Default color
          userIcon.style.color = "white";
          userIcon.setAttribute(
            "onclick",
            "document.getElementById('login-modal').style.display='flex'"
          );
        }
      }

      function logout() {
        if (confirm("Log out?")) {
          localStorage.removeItem("token");
          checkLoginState();
          alert("Logged out.");
        }
      }

      // Run this when the page loads
      window.onload = checkLoginState;
      async function openProfile() {
        const token = localStorage.getItem("token");
        if (!token) return;

        // 1. Show the Modal
        document.getElementById("profile-modal").style.display = "flex";
        const list = document.getElementById("history-list");
        list.innerHTML = "<li>Loading...</li>";

        try {
          // 2. Fetch Data from Backend
          const response = await fetch(
            "http://127.0.0.1:8000/movies/history/view",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const history = await response.json();

            // 3. Clear List
            list.innerHTML = "";

            if (history.length === 0) {
              list.innerHTML = "<li>No history yet. Search for a movie!</li>";
              return;
            }

            // 4. Render Items
            history.forEach((item) => {
              const li = document.createElement("li");
              li.style.padding = "10px 0";
              li.style.borderBottom = "1px solid #222";
              // Format: "Movie Title (Date)"
              const date = new Date(item.searched_at).toLocaleDateString();
              li.innerHTML = `<span style="color:white; font-weight:bold;">${item.movie_title}</span> <span style="font-size:0.8em; float:right;">${date}</span>`;
              list.appendChild(li);
            });
          }
        } catch (error) {
          console.error(error);
          list.innerHTML = '<li style="color:red">Failed to load history</li>';
        }
      }
      function checkLoginState() {
        const token = localStorage.getItem("token");
        const userIcon = document.querySelector(".nav-icons i");

        if (token) {
          userIcon.style.color = "#46d369"; // Green means logged in
          // CHANGE THIS LINE:
          userIcon.setAttribute("onclick", "openProfile()");
        } else {
          userIcon.style.color = "white";
          userIcon.setAttribute(
            "onclick",
            "document.getElementById('login-modal').style.display='flex'"
          );
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      // // --- 1. DATA ---
      // const genres = ["Action", "Sci-Fi", "Drama", "Adventure", "Thriller"];
      // const allMovies = [];

      // // Generate 50 dummy movies with assigned Genres
      // for(let i=1; i<=50; i++) {
      //     const genre = genres[Math.floor(Math.random() * genres.length)];
      //     allMovies.push({
      //         id: i,
      //         title: `Movie Title ${i}`,
      //         year: 2000 + Math.floor(Math.random() * 24),
      //         genre: genre,
      //         img: `https://placehold.co/400x600/1a1a1a/FFF?text=${genre}+${i}`,
      //     });
      // }

      // --- 1. DATA ---
      const genres = ["Action", "Sci-Fi", "Drama", "Adventure", "Thriller"];
      // const allMovies = [];
      // ... (the loop that generates 50 dummy movies) ...
      // let currentMovies = [...allMovies];
      // --- 1. DATA & API CONNECTION ---
      let allMovies = [];
      let currentMovies = [];

      async function fetchMovies() {
        try {
          // Fetch from YOUR Backend (The Sphere Endpoint)
          // We use year 2023 as an example to get a list
          const response = await fetch(
            "http://127.0.0.1:8000/movies/sphere/year/2023"
          );
          const data = await response.json();

          // Transform backend data to match UI expectations
          allMovies = data.map((m) => ({
            id: m.id,
            title: m.title,
            year: "2023", // Data from sphere endpoint might not have year, so we hardcode or fix backend
            genre: "Sci-Fi", // Backend needs to send genre, or we default it for now
            img: m.poster, // The backend sends 'poster', UI expects 'img'
          }));

          currentMovies = [...allMovies];

          // Refresh UI
          updateGrid(currentMovies);
          updateSphere(currentMovies);
        } catch (error) {
          console.error("Error connecting to backend:", error);
          alert("Backend is offline! Make sure uvicorn is running.");
        }
      }
      // State for filtering

      // --- 2. RENDER FUNCTIONS ---
      const grid = document.getElementById("movie-grid");
      const countDisplay = document.getElementById("count-display");

      function updateGrid(movies) {
        grid.innerHTML = "";
        // Show max 12 cards in grid to keep it clean
        movies.slice(0, 12).forEach((movie) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
                    <img src="${movie.img}" loading="lazy">
                    <div class="card-info">
                        <h3>${movie.title}</h3>
                        <p>${movie.year} â€¢ <span style="color:var(--primary)">${movie.genre}</span></p>
                    </div>
                `;
          grid.appendChild(card);
        });
        countDisplay.innerText = movies.length;
      }

      // --- 3. THREE.JS SETUP ---
      let scene,
        camera,
        renderer,
        cubes = [];
      const textureLoader = new THREE.TextureLoader();
      textureLoader.setCrossOrigin("anonymous");

      function init3D() {
        const container = document.getElementById("canvas-container");
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.z = 18;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableZoom = false;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;

        // Hover Tooltip
        const tooltip = document.createElement("div");
        Object.assign(tooltip.style, {
          position: "absolute",
          background: "rgba(0,0,0,0.9)",
          color: "#fff",
          padding: "10px",
          borderRadius: "4px",
          pointerEvents: "none",
          display: "none",
          border: "1px solid #E50914",
          zIndex: "100",
        });
        document.body.appendChild(tooltip);

        // Raycaster
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredObj = null;

        window.addEventListener("mousemove", (e) => {
          mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
          mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
          tooltip.style.left = e.clientX + 15 + "px";
          tooltip.style.top = e.clientY + 15 + "px";

          // Raycast loop inside mousemove for efficiency
          raycaster.setFromCamera(mouse, camera);
          const intersects = raycaster.intersectObjects(cubes);

          if (intersects.length > 0) {
            const target = intersects[0].object;
            if (hoveredObj !== target) {
              if (hoveredObj) hoveredObj.scale.set(1, 1, 1);
              hoveredObj = target;
              hoveredObj.scale.set(1.3, 1.3, 1.3);
              tooltip.innerHTML = `<strong>${target.userData.title}</strong><br>${target.userData.genre}`;
              tooltip.style.display = "block";
              document.body.style.cursor = "pointer";
              controls.autoRotate = false;
            }
          } else {
            if (hoveredObj) {
              hoveredObj.scale.set(1, 1, 1);
              hoveredObj = null;
              tooltip.style.display = "none";
              document.body.style.cursor = "default";
              controls.autoRotate = true;
            }
          }
        });

        // Animation Loop
        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        animate();

        // Handle Resize
        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      }

      // --- 4. UPDATE SPHERE FUNCTION ---
      // This function deletes old cubes and creates new ones based on filters
      function updateSphere(movies) {
        // Remove old meshes
        cubes.forEach((cube) => scene.remove(cube));
        cubes = [];

        const count = Math.min(movies.length, 60); // Limit to 60 for performance
        const phi = Math.PI * (3 - Math.sqrt(5));

        for (let i = 0; i < count; i++) {
          const movie = movies[i];
          const y = 1 - (i / (count - 1)) * 2;
          const radius = 10;
          const r = Math.sqrt(1 - y * y);
          const theta = phi * i;
          const x = Math.cos(theta) * r;
          const z = Math.sin(theta) * r;

          const geometry = new THREE.BoxGeometry(1.5, 2.2, 0.1);
          // Simple color fallback while loading texture
          const material = new THREE.MeshBasicMaterial({ color: 0x333333 });

          // Load texture asynchronously
          textureLoader.load(movie.img, (tex) => {
            material.map = tex;
            material.color.set(0xffffff);
            material.needsUpdate = true;
          });

          const mesh = new THREE.Mesh(geometry, material);
          mesh.position.set(x * radius, y * radius, z * radius);
          mesh.lookAt(0, 0, 0);
          mesh.userData = { title: movie.title, genre: movie.genre };

          cubes.push(mesh);
          scene.add(mesh);
        }
      }

      // --- 5. EVENT LISTENERS (SEARCH & FILTER) ---
      // document.getElementById('search-input').addEventListener('input', (e) => {
      //     const query = e.target.value.toLowerCase();
      //     const genre = document.getElementById('genre-select').value;
      //     filterData(query, genre);
      // });
      // Function to save history (needs to be available globally or inside the module)
      async function saveToHistory(movieTitle) {
        const token = localStorage.getItem("token");
        if (!token) return; // Don't save if not logged in

        // Call the new backend endpoint
        await fetch(
          `http://127.0.0.1:8000/movies/history/add?movie_title=${movieTitle}`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`, // Send the token!
            },
          }
        );
      }

      // The Search Listener
      const searchInput = document.getElementById("search-input");

      // We use 'change' or 'keypress' (Enter) instead of 'input' to avoid saving every single letter
      searchInput.addEventListener("keypress", async (e) => {
        if (e.key === "Enter") {
          const query = searchInput.value;

          // 1. Filter the 3D Sphere (Existing Logic)
          const genre = document.getElementById("genre-select").value;
          filterData(query, genre);

          // 2. Save to History (New Logic)
          saveToHistory(query);
          console.log("Saved to history:", query);
        }
      });
      document
        .getElementById("genre-select")
        .addEventListener("change", (e) => {
          const query = document
            .getElementById("search-input")
            .value.toLowerCase();
          const genre = e.target.value;
          filterData(query, genre);
        });

      function filterData(query, genre) {
        const filtered = allMovies.filter((movie) => {
          const matchesSearch =
            movie.title.toLowerCase().includes(query) ||
            movie.year.toString().includes(query);
          const matchesGenre = genre === "All" || movie.genre === genre;
          return matchesSearch && matchesGenre;
        });
        updateGrid(filtered);
        updateSphere(filtered);
      }

      // --- INIT ---
      lucide.createIcons();
      init3D(); // Setup Scene
      // updateGrid(allMovies); // Initial Grid
      // updateSphere(allMovies); // Initial Sphere
      fetchMovies(); // <-- ADD THIS NEW LINE
    </script>
  </body>
</html>
